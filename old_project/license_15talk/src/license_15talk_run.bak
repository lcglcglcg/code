
#include <jni.h>
#include <stdlib.h>
#include <string.h>
#include "license_15talk.h"

char *lg_strtok_r(char *str, char delim, char **saveptr)
{

    if (saveptr && *saveptr)
	str = *saveptr;

    if (str == NULL)
	return NULL;

    for (; *str; str++)
	if (*str != delim)
	    break;

    char *p = NULL;
    for (p = str; *p; p++) {

	if (*p == delim) {

	    *p = 0;
	    for (p++; *p; p++) {
		if (*p != delim) {

		    *saveptr = p;
		    return str;
		}
	    }
	}
    }

    if (str || *saveptr) {

	*saveptr = NULL;
	return str;
    }   

    return str;
}

void license_15talk_thrown(JNIEnv *env, char *format, ...)
{

    va_list arg_list;
    va_start(arg_list, format);

    size_t size = 0;
    char buffer[4096] = {0};

    for( ; *format; format++) {

	if (*format == '%') {

	    format++;
	    if (!(*format))
		return;

	    if (*format == 'd') {

		int value = va_arg(arg_list, int);
		size += sprintf(&buffer[size], "%d", value);

	    } else if (*format == 's') {

		char *value = va_arg(arg_list, char *);
		size += sprintf(&buffer[size], "%s", value);
	    }

	} else {

	    buffer[size++] = *format;
	}
    }

    jthrowable exc = (*env)->ExceptionOccurred(env);
    if (exc) {

	jclass newExcCls;

	(*env)->ExceptionDescribe(env);

	(*env)->ExceptionClear(env);

	newExcCls = (*env)->FindClass(env, "java/lang/IllegalArgumentException");
	if (newExcCls == NULL) {

	    return;
	}

	(*env)->ThrowNew(env, newExcCls, "thrown from C code");
    }
}



void license_15talk_run_call(JNIEnv *env, char *cls_str, char *method_str)
{

    jclass cls = (*env)->FindClass(env, cls_str);
    if (cls == NULL) {

	license_15talk_printf(env, "FindClass %s err!", cls_str);
	return;
    }

    jmethodID method = (*env)->GetStaticMethodID(env, cls, method_str, "()V");
    if (method == NULL) {

	jclass newExcCls;

	(*env)->ExceptionDescribe(env);
	(*env)->ExceptionClear(env);


	newExcCls = (*env)->FindClass(env, "java/lang/IllegalArgumentException");
	if (newExcCls == NULL) {

	    return;
	}

	(*env)->ThrowNew(env, newExcCls, "thrown from C code");

	license_15talk_printf(env, "CallStaticVoidMethod %s->%s err!", cls_str, method_str);
	return;
    }



    (*env)->CallStaticVoidMethod(env, cls, method);
}

void license_15talk_run_parse(JNIEnv *env, char *buffer)
{

    char *saveptr = NULL;
    char *cls_str = lg_strtok_r(buffer, ',',  &saveptr);
    char *method_str = lg_strtok_r(NULL, ',',  &saveptr);
    if (lg_strtok_r(NULL, ',',  &saveptr)) {

	license_15talk_printf(env, "parse packet err!");
	return;
    }

    if (!cls_str || !method_str) {

	license_15talk_printf(env, "parse packet err!");
	return;
    }

    license_15talk_run_call(env, cls_str, method_str);
}

void license_15talk_run(JNIEnv *env, char *buffer, size_t size)
{
    license_15talk_printf(env, buffer);

    char *saveptr = NULL;
    char *str = lg_strtok_r(buffer, '|',  &saveptr);
    while(str) {

	license_15talk_run_parse(env, str);
	str = lg_strtok_r(NULL, '|',  &saveptr);
    }
}


